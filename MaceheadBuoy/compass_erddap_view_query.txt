CREATE VIEW dbo.Vw_compass_erddap
AS
SELECT 
	TIMESTAMP AS time,
	RECORD AS Record,
	CASE 
		WHEN ISNULL(Airmar_Dd_Lat,Gmx_Latitude)='NAN' THEN CAST(53.33077 AS float)
		ELSE CAST(ISNULL(Airmar_Dd_Lat,Gmx_Latitude) AS float)
	END AS latitude,
	CASE 
		WHEN ISNULL(Airmar_Dd_Long,Gmx_Longitude)='NAN' THEN CAST(-9.932698 AS float)
		ELSE CAST(ISNULL(Airmar_Dd_Long,Gmx_Longitude) AS float)
	END AS longitude,
	'Mace Head' AS Station_Id,
	ISNULL(Air_Pressure_Avg,Airmar_Atmospheric_Pressure_Avg) AS Air_Pressure,
	ISNULL(Air_Temperature_Avg,Airmar_Air_Temperature_Avg) AS Air_Temperature,
	Airmar_Pitch_Max AS Airmar_Pitch_Max,
	Airmar_Pitch_Min AS Airmar_Pitch_Min,
	Airmar_Roll_Max AS Airmar_Roll_Max,
	Airmar_Roll_Min AS Airmar_Roll_Min,
	Cr6_Batt_Volt_Min AS Cr6_Batt_Volt_Min,
	Cr6_Temp_Avg AS Cr6_Temp_Avg,
	Contros_Current_Avg AS Contros_Current_Avg,
	Contros_Pco2_Avg AS Contros_Pco2_Avg,
	Contros_Voltage_Avg AS Contros_Voltage_Avg,
	Humidity_Avg AS Humidity_Avg,
	Lamp_Remain_Percent AS Lamp_Remain_Percent,
	ISNULL(Mppt1_Batt_Volt_Avg,Mppt1_V_Avg) AS Mppt1_BattV,
	Mppt1_Vpv_Avg AS Mppt1_Vpv_Avg,
	ISNULL(Mppt2_Batt_Volt_Avg,Mppt2_V_Avg) AS Mppt2_BattV,
	Mppt2_Vpv_Avg AS Mppt2_Vpv_Avg,
	Precip_Int_Avg AS Average_Percipitation,
	Sbe_Conductivity_Avg AS Sbe_Conductivity_Avg,
	SBE_DO_Avg AS SBE_DO_Avg,
	Sbe_Salinity_Avg AS Sbe_Salinity_Avg,
	Sbe_Temp_Avg AS Sbe_Temp_Avg,
	Scufa_Raw_Fluorescence_Avg AS Scufa_Raw_Fluorescence_Avg,
	Scufa_Temperature_Avg AS Scufa_Temperature_Avg,
	Seafet_Int_Humidity_Avg AS Seafet_Int_Humidity_Avg,
	Seafet_Int_Voltage_Avg AS Seafet_Int_Voltage_Avg,
	Seafet_Ph_Ext_Avg AS Seafet_Ph_Ext_Avg,
	Seafet_Ph_Int_Avg AS Seafet_Ph_Int_Avg,
	Seafet_Temp_Avg AS Seafet_Temp_Avg,
	Suna_Absorbance_254nm_Avg AS Suna_Absorbance_254nm_Avg,
	Suna_Absorbance_350nm_Avg AS Suna_Absorbance_350nm_Avg,
	Suna_Bromide_Avg AS Suna_Bromide_Avg,
	Suna_Dark_Value_Avg AS Suna_Dark_Value_Avg,
	Suna_Int_Humidity_Avg AS Suna_Int_Humidity_Avg,
	Suna_Int_Temp_Avg AS Suna_Int_Temp_Avg,
	Suna_Int_Voltage_Avg AS Suna_Int_Voltage_Avg,
	Suna_Main_Current_Avg AS Suna_Main_Current_Avg,
	Suna_Main_Voltage_Avg AS Suna_Main_Voltage_Avg,
	Suna_Nitrate_Conc_Avg AS Suna_Nitrate_Conc_Avg,
	Suna_Nitrogen_Avg AS Suna_Nitrogen_Avg,
	Suna_Spectrum_Avrg_Avg AS Suna_Spectrum_Avrg_Avg,
	Total_Precip_Avg AS Total_Precip_Avg,
	ISNULL(Airmar_Wind_Gust_Max,Wind_Gust_Max) AS Wind_Gust,
	ISNULL(Airmar_Wind_Speed_Avg,Wind_Speed) AS Wind_Speed,
	ISNULL(Avrg_Wind_Direction_Wvc,Wind_Direction) AS Wind_Direction
FROM 
(
SELECT 
	Timestamp, 
	Record, 
	Parameter, 
	[Value] 
FROM 
	dbo.compass_flat) p
PIVOT
(
MAX([Value])
FOR Parameter
IN
(Air_Pressure_Avg,
Air_Temperature_Avg,
Airmar_Air_Temperature_Avg,
Airmar_Atmospheric_Pressure_Avg,
Airmar_DD_Lat,
Airmar_DD_Long,
Airmar_Pitch_Max,
Airmar_Pitch_Min,
Airmar_Roll_Max,
Airmar_Roll_Min,
Airmar_Wind_Gust_Max,
Airmar_Wind_Speed_Avg,
Avrg_Wind_Direction_WVc,
Contros_Current_Avg,
Contros_PCO2_Avg,
Contros_Voltage_Avg,
CR6_Batt_volt_Min,
CR6_Temp_Avg,
GMX_Latitude,
GMX_Longitude,
Humidity_Avg,
Lamp_Remain_Percent,
MPPT1_Batt_Volt_Avg,
MPPT1_V_Avg,
MPPT1_VPV_Avg,
MPPT2_Batt_Volt_Avg,
MPPT2_V_Avg,
MPPT2_VPV_Avg,
Precip_Int_Avg,
SBE_Conductivity_Avg,
SBE_DO_Avg,
SBE_Salinity_Avg,
SBE_Temp_Avg,
Scufa_Raw_Fluorescence_Avg,
Scufa_Temperature_Avg,
SeaFet_INT_Humidity_Avg,
SeaFet_INT_Voltage_Avg,
SeaFet_PH_EXT_Avg,
SeaFet_PH_INT_Avg,
SeaFet_Temp_Avg,
Suna_Absorbance_254nm_Avg,
Suna_Absorbance_350nm_Avg,
Suna_Bromide_Avg,
Suna_Dark_Value_Avg,
Suna_Int_Humidity_Avg,
Suna_Int_Temp_Avg,
Suna_Int_Voltage_Avg,
Suna_Main_Current_Avg,
Suna_Main_Voltage_Avg,
Suna_Nitrate_Conc_Avg,
Suna_Nitrogen_Avg,
Suna_Spectrum_Avrg_Avg,
Total_Precip_Avg,
Wind_Direction,
Wind_Gust_Max,
Wind_Speed)) AS pvt